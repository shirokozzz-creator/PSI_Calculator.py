import streamlit as st
from fpdf import FPDF
import random
import io

# --- 1. PDF ç”¢å‡ºå‡½æ•¸ (å®šç¾©åœ¨æœ€ä¸Šæ–¹ï¼Œé¿å…ç¸®æ’éŒ¯èª¤) ---
def generate_psi_pdf(age, height, weight, body_fat, total_score, diagnosis):
    pdf = FPDF()
    pdf.add_page()
    
    # å˜—è©¦è¼‰å…¥å­—å‹ï¼Œè‹¥å¤±æ•—å‰‡é€€å› Arial
    try:
        # ç¢ºä¿ msjh.ttc å·²ç¶“å¾ Brian-car-ai ä¸‹è¼‰ä¸¦ä¸Šå‚³åˆ°æœ¬å°ˆæ¡ˆæ ¹ç›®éŒ„
        pdf.add_font('MSJH', '', 'msjh.ttc')
        pdf.set_font('MSJH', size=12)
        title_text = "PSI æ´¾å¤§æ˜ŸæŒ‡æ•¸è¨ºæ–·å ±å‘Š"
        result_text = f"æœ€çµ‚å¾—åˆ†ï¼š{total_score}%"
        diag_label = "è¨ºæ–·çµæœï¼š"
    except:
        pdf.set_font("Arial", size=12)
        title_text = "PSI Diagnosis Report"
        result_text = f"Final Score: {total_score}%"
        diag_label = "Diagnosis: "

    pdf.cell(200, 10, txt=title_text, ln=True, align='C')
    pdf.ln(10)
    pdf.cell(200, 10, txt=f"Age: {age}", ln=True)
    pdf.cell(200, 10, txt=f"Height: {height} cm / Weight: {weight} kg", ln=True)
    pdf.cell(200, 10, txt=f"Body Fat: {body_fat}%", ln=True)
    pdf.cell(200, 10, txt=result_text, ln=True)
    pdf.ln(5)
    pdf.multi_cell(0, 10, txt=f"{diag_label} {diagnosis}")
    pdf.ln(10)
    pdf.set_font_size(10)
    pdf.cell(200, 10, txt="Generated by Brian Aerospace Data Lab", ln=True, align='R')
    
    return pdf.output()

# --- 2. ç¶²é è¨­å®šèˆ‡ Session State ---
st.set_page_config(page_title="PSI æŒ‡æ•¸ - é€šç”¨è¨ºæ–·ç‰ˆ", page_icon="ğŸ§¬")

if 'weights' not in st.session_state:
    # ç‚º 10 é¡Œç”Ÿæˆéš¨æ©Ÿæ¬Šé‡ï¼Œé¿å…æ¸¬è©¦è€…é åˆ¤
    st.session_state.weights = [random.sample([0, 5, 10], 3) for _ in range(10)]

st.title("ğŸ§¬ PSI æ´¾å¤§æ˜ŸæŒ‡æ•¸ (General Version)")
st.markdown("---")

# --- 3. åŸºç¤æ•¸æ“šè¼¸å…¥ ---
st.sidebar.header("ğŸ‘¤ å—æ¸¬è€…åŸºæœ¬è³‡æ–™")
# é è¨­å€¼åƒè€ƒä½¿ç”¨è€…æ•¸æ“šï¼š181cm/74kg/19.5%
age = st.sidebar.number_input("å¹´é½¡", min_value=10, max_value=100, value=41)
height = st.sidebar.number_input("èº«é«˜ (cm)", min_value=100, max_value=250, value=181)
weight = st.sidebar.number_input("é«”é‡ (kg)", min_value=30, max_value=200, value=74)
body_fat = st.sidebar.number_input("é«”è„‚ç‡ (%)", min_value=5.0, max_value=50.0, value=19.5, step=0.1)

# --- 4. è¨ºæ–·é¡Œç›® ---
st.header("ğŸ“ èªçŸ¥èˆ‡ç’°å¢ƒè¨ºæ–·")

questions = [
    ("1. å°æ–¼ç›®å‰çš„è·æ¥­ç¾ç‹€ï¼Œä½ çš„æ€ç¶­æ˜¯ï¼Ÿ", ["è¿½æ±‚çµ•å°ç©©å®šï¼Œé¢¨éšªè¶Šä½è¶Šå¥½", "åœ¨ç©©å®šä¸­å°‹æ±‚è‡ªæˆ‘åƒ¹å€¼çš„çªç ´", "ä¸»å‹•æ“æŠ±è®Šå‹•ï¼Œè¦–å±æ©Ÿç‚ºæ§“æ¡¿"]),
    ("2. é—œæ–¼ä¸‹ç­å¾Œçš„é–’æš‡æ™‚é–“åˆ©ç”¨ï¼Ÿ", ["ä¸»è¦ç”¨æ–¼å¨›æ¨‚æ”¾é¬†ã€èˆ’ç·©å·¥ä½œå£“åŠ›", "éš¨æ„å®‰æ’ï¼Œçœ‹ç•¶å¤©å¿ƒæƒ…è€Œå®š", "æœ‰ç³»çµ±åœ°å­¸ç¿’æ–°æŠ€èƒ½æˆ–ç¶“ç‡Ÿè¤‡åˆ©è³‡ç”¢"]),
    ("3. é¢å°è¤‡é›œä¸”æœªçŸ¥çš„æŠ€è¡“å•é¡Œæ™‚ï¼Ÿ", ["å‚¾å‘äº¤çµ¦å°ˆå®¶è™•ç†ï¼Œä¸æ·±ç©¶åº•å±¤é‚è¼¯", "å˜—è©¦ç†è§£åŸºæœ¬åŸç†ï¼Œä½†é‡åˆ°å›°é›£æœƒåœä¸‹", "é‹ç”¨åº•å±¤é‚è¼¯æ‹†è§£ï¼Œç›´åˆ°å¾¹åº•æŒæ¡é—œéµ"]),
    ("4. ä½ å°ç›®å‰ç”Ÿæ´»ç’°å¢ƒçš„ã€å±æ©Ÿæ„Ÿã€ç¨‹åº¦ï¼Ÿ", ["éå¸¸å®‰é€¸ï¼Œè¦ºå¾—ç¾ç‹€å¯ä»¥ç¶­æŒä¸€è¼©å­", "å¶çˆ¾æ„Ÿåˆ°ç„¦æ…®ï¼Œä½†ä¸çŸ¥è¡Œå‹•æ–¹å‘", "å…·å‚™å¼·çƒˆç©æ¥µä¸é©æ„Ÿï¼Œä¸¦è½‰åŒ–ç‚ºå…·é«”ç”¢å‡º"]),
    ("5. é—œæ–¼å€‹äººè²¡å‹™æ€ç¶­ï¼Ÿ", ["æ²’æœ‰å…·é«”è¦åŠƒï¼Œé ˜è–ªæ°´å¾Œéš¨æ„é–‹æ”¯", "æœ‰å„²è“„ç¿’æ…£ï¼Œä¸»è¦é å‹åŠ›æ›å–å ±é…¬", "ç²¾ç®—è³‡ç”¢é…ç½®ï¼Œè‡´åŠ›æ–¼å°‡æ¶ˆè²»è½‰åŒ–ç‚ºè³‡ç”¢"]),
    ("6. ç¤¾äº¤åœˆçš„å…§å®¹å¤§å¤šåœç¹åœ¨ï¼Ÿ", ["æŠ±æ€¨æ”¿ç­–ã€æ˜æ˜Ÿå…«å¦æˆ–ç‘£ç¢æ—¥å¸¸", "ç”Ÿæ´»æƒ…å ±åˆ†äº«ã€ç¾é£Ÿæˆ–ä¸€èˆ¬å¨›æ¨‚", "è²¡å¯Œå¢é•·ã€æŠ€è¡“é€²æ­¥èˆ‡å“²å­¸æ€è€ƒ"]),
    ("7. é¢å°èº«é«”ç´ è³ªï¼ˆé«”æ…‹/å¥åº·ï¼‰çš„è‡ªæˆ‘ç®¡ç†ï¼Ÿ", ["é †å…¶è‡ªç„¶ï¼Œä¸åˆ»æ„ç¯€åˆ¶", "æœ‰æ„è­˜åœ°ç®¡ç†ï¼Œä½†ç¼ºä¹æ•¸æ“šåŒ–ç›£æ§", "è¦–é«”æ…‹ç‚ºå€‹äººç«¶çˆ­åŠ›ï¼Œåš´æ ¼æ•¸æ“šåŒ–ç®¡ç†"]),
    ("8. å­¸ç¿’æ–°çŸ¥è­˜çš„é »ç‡èˆ‡æ·±åº¦ï¼Ÿ", ["å¾ˆä¹…æ²’æœ‰è®€å®Œä¸€æ•´æœ¬å°ˆæ¥­æ›¸ç±", "è¢«å‹•æ¥å—è³‡è¨Šç¢ç‰‡ï¼Œéš¨çœ‹éš¨å¿˜", "æ¯å¤©ä¸»å‹•æ”å–é«˜å«é‡‘é‡çŸ¥è­˜ä¸¦å…§åŒ–"]),
    ("9. å°æ–¼ã€æ™‚é–“ã€çš„èªçŸ¥ï¼Ÿ", ["æ™‚é–“æ˜¯å¯ä»¥ç”¨ä¾†æ›å–é‡‘éŒ¢æˆ–å¨›æ¨‚çš„è³‡æº", "è¦ºå¾—æ™‚é–“éå¾—å¾ˆå¿«ï¼Œä½†ä¸æ¸…æ¥šç”¢å‡ºç‚ºä½•", "æ™‚é–“æ˜¯ç”Ÿå‘½ä¸­æœ€çè²´çš„è³‡ç”¢ï¼Œæ¥µåº¦æ’æ–¥ç†µå¢"]),
    ("10. å¦‚æœç¾åœ¨å¤±å»ç©©å®šçš„è–ªæ°´æ”¶å…¥ï¼Ÿ", ["æœƒé™·å…¥ææ…Œï¼Œå› ç‚ºç¼ºä¹å…¶ä»–ç”Ÿå­˜æŠ€èƒ½", "é›–ç„¶æ“”å¿ƒï¼Œä½†æ‡‰è©²èƒ½å‹‰å¼·æ”¯æ’ä¸€æ®µæ™‚é–“", "å……æ»¿ä¿¡å¿ƒï¼Œå› ç‚ºå…·å‚™å¼·å¤§çš„å¸‚å ´ç«¶çˆ­åŠ›"])
]

user_responses = []
with st.form("psi_form"):
    for i, (q_text, opts) in enumerate(questions):
        st.write(f"**{q_text}**")
        choice = st.radio(f"Select_{i}", opts, label_visibility="collapsed")
        user_responses.append(opts.index(choice))
    
    submitted = st.form_submit_button("åŸ·è¡Œæ•¸æ“šåˆ†æä¸¦ç”¢ç”Ÿå ±å‘Š")

# --- 5. çµæœè¨ˆç®—èˆ‡ PDF ä¸‹è¼‰ ---
if submitted:
    # æ ¹æ“š Session State ä¸­çš„éš¨æ©Ÿæ¬Šé‡è¨ˆç®—åˆ†æ•¸
    total_score = sum(st.session_state.weights[i][user_responses[i]] for i in range(10))
    
    st.divider()
    
    # æ ¹æ“šåˆ†æ•¸æ±ºå®šé¡è‰²
    if total_score <= 25:
        score_color = "#28a745"  # ç¶ è‰²
        status_title = "ã€ èˆªå¤ªç´šéˆé­‚ ã€‘"
        shock_msg = "ç¶­æŒå¾—å¾ˆå¥½ï¼Œä½ ç›®å‰ä¾ç„¶æŒæ§è‘—è‡ªå·±çš„èˆªå¤ªå¼•æ“ã€‚"
    elif total_score <= 50:
        score_color = "#ffc107"  # é»ƒè‰²
        status_title = "ã€ èªçŸ¥ç”Ÿé½é è­¦ ã€‘"
        shock_msg = "è­¦å ±ï¼šå¹³åº¸æ„Ÿæ­£åœ¨ä¾µè•ä½ çš„ç¥ç¶“ï¼Œä½ å¿«è¦è®Šæˆæ´¾å¤§æ˜Ÿäº†ï¼"
    else:
        score_color = "#dc3545"  # ç´…è‰²
        status_title = "ã€ æ·±åº¦æµ·æ˜Ÿç‹€æ…‹ ã€‘"
        shock_msg = "å±éšªï¼ä½ çš„å¤§è…¦å·²é€²å…¥éœæ…‹æå£ï¼Œå†ä¸è¡Œå‹•å°±çœŸçš„è®Šæˆäº†å»¢æŸ´å¤§å”ï¼"

    # --- é†’ç›®çš„å·¨å¤§æ•¸å­—èˆ‡æ¨™é¡Œ ---
    st.markdown(f"""
        <div style="text-align: center; padding: 20px; border: 5px solid {score_color}; border-radius: 15px;">
            <h2 style="color: {score_color}; margin-bottom: 0;">{status_title}</h2>
            <p style="font-size: 80px; font-weight: 800; color: {score_color}; margin: 0;">{total_score}%</p>
            <h3 style="color: #555;">æ´¾å¤§æ˜ŸæŒ‡æ•¸ (PSI)</h3>
            <hr style="border: 1px solid #ddd;">
            <p style="font-size: 24px; font-weight: bold; color: #333;">{shock_msg}</p>
        </div>
    """, unsafe_allow_html=True)
    
    st.markdown("---")

    # è¨ºæ–·èªå¥ (ç”¨æ–¼ PDF)
    diagnosis = f"{status_title} {shock_msg}"

    # ç”¢å‡º PDF å…§å®¹
    pdf_bytes = generate_psi_pdf(age, height, weight, body_fat, total_score, diagnosis)
    
    # ä¸‹è¼‰æŒ‰éˆ•ä¹Ÿåšé†’ç›®ä¸€é»
    st.download_button(
        label="ğŸ“¥ é»æ­¤é ˜å–ä½ çš„ã€èˆªå¤ªç´šè¨ºæ–·å ±å‘Šæ›¸ã€",
        data=bytes(pdf_bytes),
        file_name=f"PSI_Report_{age}.pdf",
        mime="application/pdf",
        use_container_width=True
    )
